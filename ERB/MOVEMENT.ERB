;-------------------------------------------------------------------------------
;キャラクターの移動
@CHARA_MOVEMENT
	#DIM LOOP_CHR
	#DIM WK
	;訪問者の移動処理
	CALL VISITER_MOVEMENT
	;同行者への影響チェック
	CALL NTR_CHK_GOWITH(TIME_PROGRESS(TFLAG:300))
	FOR LOOP_CHR,0,CHARANUM
		;尿量/便量増加@お手洗い勝手に拡張パッチ
		TRYCALL REST_PeePoo_Increase(LOOP_CHR)
		; 紅魔館エリアの外なら移動しない（霊夢の寝床は特殊）
		SIF CFLAG:LOOP_CHR:現在位置 >= 場所_訪問者宅 && CFLAG:LOOP_CHR:現在位置 != 場所_博麗神社 && CFLAG:LOOP_CHR:現在位置 != 場所_人間の里
			CONTINUE
		;MASTERを部屋から追い出すチェック
		CALL TURN_OUT_WHEN_SLEEP(LOOP_CHR)
		;BASEの自然変動
		CALL CHANGE_BASE(LOOP_CHR)
		;会話累積値の変動
		CALL CHANGE_TALK_VALUE(LOOP_CHR)
		;身体の清潔度の変動
		CALL CHANGE_CLEANLINESS(LOOP_CHR)
		;同行フラグ（1時間持続）
		CALL CHANGE_GOWITH(LOOP_CHR)
		;起床後の着替え
		CALL CHANGE_CLOTHES(LOOP_CHR)
		
		IF LOOP_CHR != MASTER
			;あなた以外の処理
			CALL MOVEMENT_CHARA_SUB(LOOP_CHR)
		ENDIF
		;母乳ダダ漏れ対応
		CALL PREGNACY_S_Milking(LOOP_CHR)
		;汚れを付ける
		WK = CFLAG:LOOP_CHR:睡眠 ? 0 # 1 + TALENT:LOOP_CHR:幼稚 - 2 * ABL:LOOP_CHR:清掃技能
		FLAG:(100 + CFLAG:LOOP_CHR:現在位置) = MAX(FLAG:(100 + CFLAG:LOOP_CHR:現在位置) + WK * TIME_PROGRESS(TFLAG:300),0)
		FLAG:(100 + CFLAG:LOOP_CHR:現在位置) = MIN(FLAG:(100 + CFLAG:LOOP_CHR:現在位置),6000)
	NEXT

	FOR LOOP_CHR,0,CHARANUM
		;トイレを済ませれたか、漏らしたかのチェック@お手洗い勝手に拡張パッチ
		CALL REST_MovementCheck(LOOP_CHR)
	NEXT

	;カメラ設置パッチ対応
	TRYCALL SECRET_CAMERA
	CALL INTRUDER_MOVEMENT

;-------------------------------------------------------------------------------
;MASTERを部屋から追い出す
@TURN_OUT_WHEN_SLEEP(住人)
	#DIM 住人
	#DIM LOOP_POS
	;MASTER以外が、睡眠中、MASTERと同室で、恋慕状態でなく、施錠ができて、MASTERの子供 でなく、MASTERの起きる部屋でなければ追い出す
	IF 住人 > 0 && CFLAG:住人:睡眠 && CFLAG:住人:現在位置 == CFLAG:MASTER:現在位置 && !TALENT:住人:恋慕 && FLAG:(300 + CFLAG:MASTER:現在位置) && CFLAG:住人:現在位置 != CFLAG:MASTER:開始位置
		SIF (NO:住人 == 148 || NO:住人 == 149) && (CFLAG:住人:父親 == MASTER || CFLAG:住人:母親 == MASTER)
			RETURN
		IF CFLAG:住人:衰弱
			PRINTFORML %CALLNAME:住人% got tired and fell asleep...
		ELSE
			IF CFLAG:住人:成長度 == 成長度_乳児 || CFLAG:住人:成長度 == 成長度_幼児
				;赤ん坊、幼子相手には遠慮してあげる優しいMASTER
				PRINTFORML Sleepy %CALLNAME:住人% asked %CALLNAME:MASTER% to leave the room reluctantly...
			ELSE
				PRINTFORML %CALLNAME:住人% has thrown you out...
			ENDIF
		ENDIF
		FOR LOOP_POS,0,MAXROOM()
			;庭は除外
			SIF LOOP_POS == 場所_庭
				CONTINUE
			IF CAN_MOVE(CFLAG:MASTER:現在位置, LOOP_POS)
				CFLAG:MASTER:現在位置 = LOOP_POS
				BREAK
			ENDIF
		NEXT
		;うふふリセット
		CVARSET CFLAG, 317
	ENDIF
RETURN

;-------------------------------------------------------------------------------
;BASEの自然変動
@CHANGE_BASE(住人)
	#DIM 住人
	;MASTERと同じ場所にいないとき
	IF CFLAG:住人:現在位置 != CFLAG:MASTER:現在位置
		BASE:住人:ムード = BASE:住人:ムード - TIME_PROGRESS(TFLAG:300) * 2 * (BASE:住人:ムード + 1000) / 1000
		BASE:住人:ムード = MAX(0,BASE:住人:ムード)
		BASE:住人:理性 = BASE:住人:理性 + TIME_PROGRESS(TFLAG:300) * (MAXBASE:住人:理性 + 1000) / ((BASE:住人:理性 + 1000) * 2)
		BASE:住人:理性 = MIN(MAXBASE:住人:理性,BASE:住人:理性)
	ENDIF
	;怒りは常に減少する
	BASE:住人:怒り = BASE:住人:怒り - TIME_PROGRESS(TFLAG:300) * 5 / (CFLAG:住人:怒り + 1)
	SIF BASE:住人:怒り <= 0
		CFLAG:住人:怒り = 0
	BASE:住人:怒り = MAX(0,BASE:住人:怒り)
	;不機嫌
	SIF CFLAG:住人:不機嫌
		BASE:住人:怒り = MAXBASE:住人:怒り
	;勃起度の自然減少
	SIF CFLAG:住人:勃起度２ <= CFLAG:住人:勃起度 && !TCVAR:住人:イきそう
		BASE:住人:勃起 = MAX(0,BASE:住人:勃起 - TIME_PROGRESS(TFLAG:300) * 20)
	;衰弱の処理
	IF CFLAG:住人:衰弱
		BASE:住人:体力 = MIN(BASE:住人:体力 + 2 * TIME_PROGRESS(TFLAG:300),MAXBASE:住人:体力)
		BASE:住人:気力 = MIN(BASE:住人:気力 + 2 * TIME_PROGRESS(TFLAG:300),MAXBASE:住人:気力)
		CFLAG:住人:衰弱 = MAX(CFLAG:住人:衰弱 - TIME_PROGRESS(TFLAG:300),0)
	ENDIF
RETURN

;-------------------------------------------------------------------------------
;会話累積値の変動
@CHANGE_TALK_VALUE(住人)
	#DIM 住人
	SIF TCVAR:住人:会話累積値 > 100
		TCVAR:住人:会話不能 = 1
	TCVAR:住人:会話累積値 = MAX(TCVAR:住人:会話累積値 - TIME_PROGRESS(TFLAG:300) , 0)
	SIF TCVAR:住人:会話累積値 == 0
		TCVAR:住人:会話不能 = 0
RETURN

;-------------------------------------------------------------------------------
;身体の清潔度の変動
@CHANGE_CLEANLINESS(住人)
	#DIM 住人
	#DIM 入浴フラグ
	
	入浴フラグ = CFLAG:住人:風呂
	CFLAG:住人:風呂 += TIME_PROGRESS(TFLAG:300)
	IF BATHROOM(CFLAG:住人:現在位置)
		SIF 住人 == 0 && 入浴フラグ
			PRINTFORMW %CALLNAME:MASTER% relaxed in the bath.
		CFLAG:住人:風呂 = 0
	ENDIF
	IF CFLAG:住人:風呂 == 0
		RESET_STAIN 住人
		;アヌスを洗う
		STAIN:住人:Ａ = 汚れ_なし
		CFLAG:住人:射精者M = 0
		CFLAG:住人:射精者V = 0
		CFLAG:住人:射精者A = 0
	ELSEIF CFLAG:住人:風呂 > 120 && !CFLAG:住人:うふふ
		STAIN:住人:Ａ |= 汚れ_アナル
	ENDIF
RETURN

;-------------------------------------------------------------------------------
;同行フラグの変動
@CHANGE_GOWITH(住人)
	#DIM 住人
	CFLAG:住人:同行 = MAX(CFLAG:住人:同行 - TIME_PROGRESS(TFLAG:300),0)
	SIF CFLAG:住人:同行
		CFLAG:住人:現在位置 = CFLAG:MASTER:現在位置
	
	SIF CFLAG:住人:起床後寝間着時間
		CFLAG:住人:起床後寝間着時間 = MAX(CFLAG:住人:起床後寝間着時間 - TIME_PROGRESS(TFLAG:300),0)
RETURN

;-------------------------------------------------------------------------------
;起床後の着替え
@CHANGE_CLOTHES(住人)
	#DIM 住人
	;起床後部屋を出ず1時間経つと衣服変更
	IF !CFLAG:住人:うふふ && CFLAG:住人:寝間着着用 && !CFLAG:住人:起床後寝間着時間 && !CFLAG:住人:起床時間外 && !CFLAG:住人:衰弱 && !CFLAG:住人:睡眠
		;寝間着から着替える時だけ下着を替える
		;DEBUGPRINTFORML %CALLNAME:住人+"は寝間着から着替えます。下着を替えます。"%
		CALL CLOTHES_SETTING(住人,1)
	ENDIF
RETURN

;-------------------------------------------------------------------------------
;あなた以外の住人の処理
@MOVEMENT_CHARA_SUB(住人)
	#DIM 住人
	#DIM 目標地点

	;キャラクターの移動条件(ルート消去)
	CALL CHARA_MOVEMENT_T(住人)
	IF 0 == RESULT		; 0:行動不可
		;移動が出来なかった場合ルート消去
		SIF 移動ルート:住人:0
			CALLF RESET_ROUTE(住人, 1)
		RETURN
	ENDIF
	;キャラクターの移動
	CALL CHARA_MOVEMENT_T2(住人)
	SIF 0 == RESULT		; 0:行動不可
		RETURN
	目標地点 = RESULT		; 0:移動しない
	;訪問者と同じ位置にいて、屈服度が高い状態なら訪問者によるお仕置きが発生
	IF CFLAG:住人:現在位置 == FLAG:訪問者の現在位置
		IF IS_NTR_SOFT()
			SIF CFLAG:住人:屈服度 > 1000 && (CFLAG:住人:屈服度 - 500) > RAND:500 && GET_N_WITH_VISITER(住人) == 1 && FLAG:訪問者のムード >= 3
				TRYCALL NTR_PUNISHMENT(住人)
		ELSE
			SIF CFLAG:住人:屈服度 > 500 && (CFLAG:住人:屈服度 - 500) > RAND:500 && GET_N_WITH_VISITER(住人) == 1
				TRYCALL NTR_PUNISHMENT(住人)
		ENDIF
	ENDIF
	
	;その場から動かない場合は移動処理をスキップ
	IF CFLAG:住人:現在位置 != 目標地点
		IF (CAN_MOVE(CFLAG:MASTER:現在位置, CFLAG:住人:現在位置) == 2 || CFLAG:住人:同室) && !CFLAG:MASTER:睡眠
			PRINTFORMW %CALLNAME:住人% has moved from【%GETPLACENAME(CFLAG:住人:現在位置)%】towards【%GETPLACENAME(目標地点)%】
		ENDIF
		;起床時間内で寝間着を着ている場合は移動時に私服に戻る
		IF CFLAG:住人:寝間着着用
			IF !CFLAG:住人:起床時間外
				;DEBUGPRINTFORML %CALLNAME:住人+"は移動するので寝間着から着替えます。下着を替えます。"%
				CALL CLOTHES_SETTING(住人,1)
			ELSE
				;そうでない場合は靴を履いて移動
				CALL CLOTHES_Preset_NIGHTWEAR_S(住人)
			ENDIF
		ENDIF
		;DEBUGPRINTFORML %CALLNAME:住人%:%GETPLACENAME(CFLAG:住人:現在位置)%→%GETPLACENAME(目標地点)%
		IF 目標地点
			;IF CFLAG:住人:現在位置 == FLAG:訪問者の現在位置
			;	FLAG:訪問者のムード = 0
			;	FLAG:訪問者との行為の終了時刻 = 0
			;	FLAG:訪問者との行為 = 0
			;ENDIF
			CFLAG:住人:現在位置 = 目標地点
			CALL NTR_CHK_CHAR_MOVE(住人)
		ENDIF
	ENDIF
	
	;移動後直ぐのイベント
	IF GETBIT(FLAG:催眠設定,1)
		;赤ん坊、幼児は勝手に人里までは行けないことにします。
		IF CFLAG:住人:成長度 != 成長度_乳児 && CFLAG:住人:成長度 != 成長度_幼児
			IF CFLAG:住人:現在位置 == 場所_正門 && RAND:50 < 15
				PRINTFORMW %CALLNAME:住人% went out to the Human Village.
				CFLAG:住人:現在位置 = 場所_人間の里
				CFLAG:住人:汚れ発覚 = 汚れ発覚_なし
				;ルートが設定されていればリセット
				SIF 移動ルート:住人:0
					CALLF RESET_ROUTE(住人, 0)
			ENDIF
			IF CFLAG:住人:現在位置 == 場所_人間の里 && !FLAG:催眠 && RAND:50 < 25
				PRINTFORMW %CALLNAME:住人% followed some suspicious man.
				CFLAG:住人:現在位置 = 場所_民家
				CFLAG:住人:汚れ発覚 = 汚れ発覚_なし
				SIF 移動ルート:住人:0
					CALLF RESET_ROUTE(住人, 0)
			ENDIF
		ENDIF
	ENDIF
RETURN

;-------------------------------------------------------------------------------
;美鈴
@CHARA_MOVEMENT_ACTIVETIME_1(住人)
	#DIM 住人

	;22時〜6時、13時〜14時は寝てる
RETURN TIME < 360 || (TIME > 780 && TIME < 840)|| TIME > 1320 || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_1
RETURN 90

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_1(ARG,ARG:1)
	;書かれていない場所へは移動しない
	RESULT:1 = 場所_正門 * 倍_万 + 100
	RESULT:2 = 場所_守衛小屋 * 倍_万 + 100
	RESULT:3 = 場所_庭 * 倍_万 + 100
	RESULT:4 = 場所_湖 * 倍_万 + 100
	RESULT:5 = 場所_広間 * 倍_万 + 80
	RESULT:6 = 場所_食堂 * 倍_万 + 80
	RESULT:7 = 場所_厨房 * 倍_万 + 80
	RESULT:8 = 場所_図書室 * 倍_万 + 60
	RESULT:9 = 場所_二階踊り場 * 倍_万 + 60
	RESULT:10 = 場所_二階廊下 * 倍_万 + 40
	RESULT:11 = 場所_咲夜私室 * 倍_万 + 20
	RESULT:12 = 場所_妖精メイド詰め所 * 倍_万 + 20
	
	LOCAL:3 = 13
	;お手洗いパッチ
	;基本的には屋外トイレを使用
	;2Fトイレはかなり条件が揃わないと使用しない
	IF REST_NeedRestroom(ARG:1)
		FOR LOCAL,0,CHARANUM
			SIF CFLAG:LOCAL:現在位置 == 場所_屋外トイレ
				LOCAL:1++
			SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
				LOCAL:2 ++
		NEXT
		IF LOCAL:1 != 0 && LOCAL:2 > 1
			RESULT:(LOCAL:3) = 場所_2Fトイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
		IF LOCAL:2 < 2 && LOCAL:1 != 0
			RESULT:(LOCAL:3) = 場所_1Fトイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
		IF LOCAL:1 == 0
			RESULT:(LOCAL:3) = 場所_屋外トイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
	ENDIF
	
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF


;-------------------------------------------------------------------------------
;小悪魔
@CHARA_MOVEMENT_ACTIVETIME_2(住人)
	#DIM 住人

	;2時〜10時は寝てる
RETURN (TIME > 120 && TIME < 600) || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_2
RETURN 90

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_2(ARG,ARG:1)
	;書かれていない場所へは移動しない
	RESULT:1 = 場所_図書室 * 倍_万 + 100
	RESULT:2 = 場所_小悪魔私室 * 倍_万 + 100
	RESULT:3 = 場所_広間 * 倍_万 + 90
	RESULT:4 = 場所_食堂 * 倍_万 + 80
	RESULT:5 = 場所_正門 * 倍_万 + 80
	RESULT:6 = 場所_二階踊り場 * 倍_万 + 80
	RESULT:7 = 場所_厨房 * 倍_万 + 60
	RESULT:8 = 場所_庭 * 倍_万 + 60
	RESULT:9 = 場所_二階廊下 * 倍_万 + 60
	RESULT:10 = 場所_妖精メイド詰め所 * 倍_万 + 40
	
	LOCAL:3 = 11
	;パチュリーが在室なら私室に入れる
	IF CFLAG:3:現在位置 == 場所_パチュリー私室
		RESULT:(LOCAL:3) = 場所_図書室 * 倍_万 + 40
		LOCAL:3 ++
	ENDIF
	;お手洗いパッチ
	;基本的には1Fトイレを使用
	IF REST_NeedRestroom(ARG:1)
		FOR LOCAL,0,CHARANUM
			SIF CFLAG:LOCAL:現在位置 == 場所_屋外トイレ
				LOCAL:1++
			SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
				LOCAL:2 ++
		NEXT
		IF LOCAL:1 != 0 && LOCAL:2 > 1
			RESULT:(LOCAL:3) = 場所_2Fトイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
		IF LOCAL:2 < 2
			RESULT:(LOCAL:3) = 場所_1Fトイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
		IF LOCAL:2 > 2 && LOCAL:1 == 0
			RESULT:(LOCAL:3) = 場所_屋外トイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
	ENDIF
	
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF


;-------------------------------------------------------------------------------
;パチュリー
@CHARA_MOVEMENT_ACTIVETIME_3(住人)
	#DIM 住人

	;2時〜10時は寝てる
RETURN (TIME > 120 && TIME < 600) || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_3
RETURN 120

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_3(ARG,ARG:1)
	;書かれていない場所へは移動しない
	RESULT:1 = 場所_図書室 * 倍_万 + 100
	RESULT:2 = 場所_パチュリー私室 * 倍_万 + 100
	;あとはおおよそ図書室からの距離に依存
	RESULT:3 = 場所_広間 * 倍_万 + 80
	RESULT:4 = 場所_小悪魔私室 * 倍_万 + 80
	RESULT:5 = 場所_食堂 * 倍_万 + 60
	RESULT:6 = 場所_二階踊り場 * 倍_万 + 60
	RESULT:7 = 場所_厨房 * 倍_万 + 40
	RESULT:8 = 場所_二階廊下 * 倍_万 + 40
	;外周にはあまり出ない
	RESULT:9 = 場所_妖精メイド詰め所 * 倍_万 + 20
	RESULT:10 = 場所_庭 * 倍_万 + 20
	RESULT:11 = 場所_正門* 倍_万 + 20
	
	LOCAL:3 = 12
	;お手洗いパッチ
	;基本的には1Fトイレを使用
	IF REST_NeedRestroom(ARG:1)
		FOR LOCAL,0,CHARANUM
			SIF CFLAG:LOCAL:現在位置 == 場所_屋外トイレ
				LOCAL:1++
			SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
				LOCAL:2 ++
		NEXT
		IF LOCAL:1 != 0 && LOCAL:2 > 1
			RESULT:(LOCAL:3) = 場所_2Fトイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
		IF LOCAL:2 < 2
			RESULT:(LOCAL:3) = 場所_1Fトイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
		IF LOCAL:2 > 2 && LOCAL:1 == 0
			RESULT:(LOCAL:3) = 場所_屋外トイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
	ENDIF
	
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF
	

;-------------------------------------------------------------------------------
;咲夜
@CHARA_MOVEMENT_ACTIVETIME_4(住人)
	#DIM 住人

	;4時〜7時は寝てる
RETURN (TIME > 240 && TIME < 420) || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_4
RETURN 60

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_4(ARG,ARG:1)
	;書かれていない場所へは移動しない
	LOCAL:3 = 1
	FOR LOCAL:4, 1, 場所番号最大値+1
		;紅魔館内の風呂、トイレ、納屋以外の汚れている場所を優先して移動
		SIF MAP_DISTINCTION(LOCAL:4) != 0 || LOCAL:4 == 場所_納屋
			CONTINUE
		
		SELECTCASE LOCAL:4
			CASE 場所_屋外トイレ
				;お手洗いパッチ
				;基本的には1Fトイレを使用
				IF REST_NeedRestroom(ARG:1)
					FOR LOCAL,0,CHARANUM
						SIF CFLAG:LOCAL:現在位置 == 場所_屋外トイレ
							LOCAL:1++
						SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
							LOCAL:2 ++
					NEXT
					IF LOCAL:2 > 2 && LOCAL:1 == 0
						RESULT:(LOCAL:3) = 場所_屋外トイレ * 倍_万 + 10
						LOCAL:3 ++
					ENDIF
				ENDIF
			CASE 場所_1Fトイレ
				IF REST_NeedRestroom(ARG:1)
					FOR LOCAL,0,CHARANUM
						SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
							LOCAL:2 ++
					NEXT
					IF LOCAL:2 < 2
						RESULT:(LOCAL:3) = 場所_1Fトイレ * 倍_万 + 10
						LOCAL:3 ++
					ENDIF
				ENDIF
			CASE 場所_2Fトイレ
				IF REST_NeedRestroom(ARG:1)
					FOR LOCAL,0,CHARANUM
						SIF CFLAG:LOCAL:現在位置 == 場所_屋外トイレ
							LOCAL:1++
						SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
							LOCAL:2 ++
					NEXT
					IF LOCAL:1 != 0 && LOCAL:2 > 1
						RESULT:(LOCAL:3) = 場所_2Fトイレ * 倍_万 + 10
						LOCAL:3 ++
					ENDIF
				ENDIF
			CASE 場所_大浴場
				IF CFLAG:(ARG:1):風呂 >= 1000
					RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 8000
					LOCAL:3 ++
				ENDIF
			CASEELSE
				RESULT:(LOCAL:3) = LOCAL:4 * 倍_万 + (FLAG:(100 + LOCAL:4) + 100)
				LOCAL:3 ++
		ENDSELECT
	NEXT
	
	
;-------------------------------------------------------------------------------
;レミリア
@CHARA_MOVEMENT_ACTIVETIME_5(住人)
	#DIM 住人

	;6時〜18時は寝てる。ちょっと寝過ぎ。
RETURN (TIME > 360 && TIME < 1080) || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_5
RETURN 90

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_5(ARG,ARG:1)
	;書かれていない場所へは移動しない
	;紅魔館外及び納屋、外には移動しない
	RESULT:1 = 場所_レミリア私室 * 倍_万 + 100
	RESULT:2 = 場所_二階廊下 * 倍_万 + 100
	RESULT:3 = 場所_二階踊り場 * 倍_万 + 100
	RESULT:4 = 場所_広間 * 倍_万 + 100
	RESULT:5 = 場所_3Fテラス * 倍_万 + 100
	RESULT:6 = 場所_図書室 * 倍_万 + 100
	RESULT:7 = 場所_食堂 * 倍_万 + 100
	RESULT:8 = 場所_厨房 * 倍_万 + 100
	RESULT:9 = 場所_妖精メイド詰め所 * 倍_万 + 100
	;私室にも侵入する
	RESULT:10 = 場所_パチュリー私室 * 倍_万 + 80
	RESULT:11 = 場所_小悪魔私室 * 倍_万 + 80
	RESULT:12 = 場所_咲夜私室 * 倍_万 + 80
	RESULT:13 = 場所_あなた私室 * 倍_万 + 80
	RESULT:14 = 場所_地下室 * 倍_万 + 80
	
	LOCAL:3 = 15
	;お手洗いパッチ
	;基本的には1Fトイレを使用
	IF REST_NeedRestroom(ARG:1)
		FOR LOCAL,0,CHARANUM
			SIF CFLAG:LOCAL:現在位置 == 場所_屋外トイレ
				LOCAL:1++
			SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
				LOCAL:2 ++
		NEXT
		IF LOCAL:1 != 0 && LOCAL:2 > 1
			RESULT:(LOCAL:3) = 場所_2Fトイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
		IF LOCAL:2 < 2
			RESULT:(LOCAL:3) = 場所_1Fトイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
	ENDIF
	
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF


;-------------------------------------------------------------------------------
;フランドール
@CHARA_MOVEMENT_ACTIVETIME_6(住人)
	#DIM 住人

	;6時〜18時は寝てる。
RETURN (TIME > 360 && TIME < 1080) || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_6
RETURN 90

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_6(ARG,ARG:1)
	;紅魔館外及び納屋、外には移動しない
	RESULT:1 = 場所_地下室 * 倍_万 + 100
	RESULT:2 = 場所_二階廊下 * 倍_万 + 100
	RESULT:3 = 場所_二階踊り場 * 倍_万 + 100
	RESULT:4 = 場所_広間 * 倍_万 + 100
	RESULT:5 = 場所_3Fテラス * 倍_万 + 100
	RESULT:6 = 場所_図書室 * 倍_万 + 100
	RESULT:7 = 場所_食堂 * 倍_万 + 100
	RESULT:8 = 場所_厨房 * 倍_万 + 100
	RESULT:9 = 場所_妖精メイド詰め所 * 倍_万 + 100
	;私室にも侵入する
	RESULT:10 = 場所_パチュリー私室 * 倍_万 + 80
	RESULT:11 = 場所_小悪魔私室 * 倍_万 + 80
	RESULT:12 = 場所_咲夜私室 * 倍_万 + 80
	RESULT:13 = 場所_あなた私室 * 倍_万 + 80
	RESULT:14 = 場所_レミリア私室 * 倍_万 + 80
	
	LOCAL:3 = 15
	;お手洗いパッチ
	;基本的には1Fトイレを使用
	IF REST_NeedRestroom(ARG:1)
		FOR LOCAL,0,CHARANUM
			SIF CFLAG:LOCAL:現在位置 == 場所_屋外トイレ
				LOCAL:1++
			SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
				LOCAL:2 ++
		NEXT
		IF LOCAL:1 != 0 && LOCAL:2 > 1
			RESULT:(LOCAL:3) = 場所_2Fトイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
		IF LOCAL:2 < 2
			RESULT:(LOCAL:3) = 場所_1Fトイレ * 倍_万 + 10
			LOCAL:3 ++
		ENDIF
	ENDIF
	
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF

;-------------------------------------------------------------------------------
;チルノ
@CHARA_MOVEMENT_ACTIVETIME_8(住人)
	#DIM 住人

	;21時〜6時は寝てる
RETURN TIME < 360 || TIME > 1260 || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_8
RETURN 70

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_8(ARG,ARG:1)
	
	;移動範囲 霧の湖周辺、紅魔館外
	RESULT:1 = 場所_チルノの家 * 倍_万 + 100
	RESULT:2 = 場所_大妖精の家 * 倍_万 + 100
	RESULT:3 = 場所_湖 * 倍_万 + 100
	RESULT:4 = 場所_湖南部 * 倍_万 + 120
	RESULT:5 = 場所_正門 * 倍_万 + 120
	RESULT:6 = 場所_庭 * 倍_万 + 120
	RESULT:7 = 場所_地下室 * 倍_万 + 120
	
	LOCAL:3 = 8
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF
	

;-------------------------------------------------------------------------------
;大妖精
@CHARA_MOVEMENT_ACTIVETIME_9(住人)
	#DIM 住人

	;21時〜6時は寝てる
RETURN TIME < 360 || TIME > 1260 || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_9
RETURN 80

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_9(ARG,ARG:1)
	;移動範囲 霧の湖周辺、紅魔館外
	RESULT:1 = 場所_大妖精の家 * 倍_万 + 100
	RESULT:2 = 場所_チルノの家 * 倍_万 + 100
	RESULT:3 = 場所_湖 * 倍_万 + 100
	RESULT:4 = 場所_湖南部 * 倍_万 + 120
	RESULT:5 = 場所_正門 * 倍_万 + 120
	RESULT:6 = 場所_庭 * 倍_万 + 120
	RESULT:7 = 場所_地下室 * 倍_万 + 120
	
	LOCAL:3 = 8
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF
	
	
;-------------------------------------------------------------------------------
;魔理沙
@CHARA_MOVEMENT_ACTIVETIME_10(住人)
	#DIM 住人

	;21時〜6時は寝てる
RETURN TIME < 360 || TIME > 1260 || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_10
RETURN 80

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_10(ARG,ARG:1)
	;移動範囲 霧の湖周辺、紅魔館外
	RESULT:1 = 場所_魔理沙の家 * 倍_万 + 100
	RESULT:2 = 場所_アリスの家 * 倍_万 + 100
	RESULT:3 = 場所_湖 * 倍_万 + 100
	RESULT:4 = 場所_湖南部 * 倍_万 + 120
	RESULT:5 = 場所_正門 * 倍_万 + 120
	RESULT:6 = 場所_庭 * 倍_万 + 120
	RESULT:7 = 場所_図書室 * 倍_万 + 120
	RESULT:8 = 場所_地下室 * 倍_万 + 120
	RESULT:9 = 場所_食堂 * 倍_万 + 120
	RESULT:10 = 場所_厨房 * 倍_万 + 120
	RESULT:11 = 場所_広間 * 倍_万 + 120
	RESULT:12 = 場所_魔法の森内部 * 倍_万 + 120
	
	LOCAL:3 = 13
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF
	
	
;-------------------------------------------------------------------------------
;霊夢
@CHARA_MOVEMENT_ACTIVETIME_11(住人)
	#DIM 住人

	;22時〜5時は寝てる
RETURN TIME < 300 || TIME > 1320 || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_11
RETURN 100

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_11(ARG,ARG:1)
	;移動範囲 霧の湖周辺、紅魔館外
	RESULT:1 = 場所_魔理沙の家 * 倍_万 + 100
	RESULT:2 = 場所_アリスの家 * 倍_万 + 100
	RESULT:3 = 場所_湖 * 倍_万 + 100
	RESULT:4 = 場所_湖南部 * 倍_万 + 120
	RESULT:5 = 場所_正門 * 倍_万 + 120
	RESULT:6 = 場所_庭 * 倍_万 + 120
	RESULT:7 = 場所_図書室 * 倍_万 + 120
	RESULT:8 = 場所_地下室 * 倍_万 + 120
	RESULT:9 = 場所_食堂 * 倍_万 + 120
	RESULT:10 = 場所_厨房 * 倍_万 + 120
	RESULT:11 = 場所_広間 * 倍_万 + 120
	RESULT:12 = 場所_魔法の森内部 * 倍_万 + 120
	
	LOCAL:3 = 13
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF
;-------------------------------------------------------------------------------
;ルーミア
@CHARA_MOVEMENT_ACTIVETIME_12(住人)
	#DIM 住人

	;5時〜9時は寝てる
RETURN (TIME > 300 && TIME < 540) || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_12
RETURN 80

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_12(ARG,ARG:1)
	
	;移動範囲 霧の湖周辺、紅魔館外
	RESULT:1 = 場所_ルーミアの住処 * 倍_万 + 100
	RESULT:2 = 場所_湖 * 倍_万 + 100
	RESULT:3 = 場所_湖南部 * 倍_万 + 120
	RESULT:4 = 場所_正門 * 倍_万 + 120
	RESULT:5 = 場所_庭 * 倍_万 + 120
	RESULT:6 = 場所_広間 * 倍_万 + 120
	RESULT:7 = 場所_魔法の森内部 * 倍_万 + 120
	
	LOCAL:3 = 8
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF
;-------------------------------------------------------------------------------
;アリス
@CHARA_MOVEMENT_ACTIVETIME_13(住人)
	#DIM 住人

	;22時〜6時は寝てる
RETURN TIME < 360 || TIME > 1320 || CFLAG:住人:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_13
RETURN 80

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_13(ARG,ARG:1)
	;移動範囲 霧の湖周辺、紅魔館外
	RESULT:1 = 場所_アリスの家 * 倍_万 + 100
	RESULT:2 = 場所_魔理沙の家 * 倍_万 + 100
	RESULT:3 = 場所_湖 * 倍_万 + 100
	RESULT:4 = 場所_湖南部 * 倍_万 + 120
	RESULT:5 = 場所_正門 * 倍_万 + 120
	RESULT:6 = 場所_庭 * 倍_万 + 120
	RESULT:7 = 場所_図書室 * 倍_万 + 120
	RESULT:8 = 場所_地下室 * 倍_万 + 120
	RESULT:9 = 場所_食堂 * 倍_万 + 120
	RESULT:10 = 場所_厨房 * 倍_万 + 120
	RESULT:11 = 場所_広間 * 倍_万 + 120
	RESULT:12 = 場所_魔法の森内部 * 倍_万 + 120
	
	LOCAL:3 = 13
	IF CFLAG:(ARG:1):風呂 >= 1000
		RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 200
	ENDIF
;-------------------------------------------------------------------------------
;あなた
@CHARA_MOVEMENT_ACTIVETIME_0(ARG)
	;21時〜6時は寝てる
RETURN TIME < 360 || TIME > 1260 || CFLAG:ARG:衰弱

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_MOVERATE_0
RETURN 60

;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 1:xxx,0:xxx
@CHARA_MOVEMENT_0(ARG,ARG:1)
	;書かれていない場所へは移動しない
	LOCAL:3 = 1
	FOR LOCAL:4, 1, 場所番号最大値+1
		;紅魔館内の風呂、トイレ、納屋以外の汚れている場所を優先して移動
		SIF MAP_DISTINCTION(LOCAL:4) != 0 || LOCAL:4 == 場所_納屋
			CONTINUE
		
		SELECTCASE LOCAL:4
			CASE 場所_屋外トイレ
				;お手洗いパッチ
				;基本的には1Fトイレを使用
				IF REST_NeedRestroom(ARG:1)
					FOR LOCAL,0,CHARANUM
						SIF CFLAG:LOCAL:現在位置 == 場所_屋外トイレ
							LOCAL:1++
						SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
							LOCAL:2 ++
					NEXT
					IF LOCAL:2 > 2 && LOCAL:1 == 0
						RESULT:(LOCAL:3) = 場所_屋外トイレ * 倍_万 + 10
						LOCAL:3 ++
					ENDIF
				ENDIF
			CASE 場所_1Fトイレ
				IF REST_NeedRestroom(ARG:1)
					FOR LOCAL,0,CHARANUM
						SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
							LOCAL:2 ++
					NEXT
					IF LOCAL:2 < 2
						RESULT:(LOCAL:3) = 場所_1Fトイレ * 倍_万 + 10
						LOCAL:3 ++
					ENDIF
				ENDIF
			CASE 場所_2Fトイレ
				IF REST_NeedRestroom(ARG:1)
					FOR LOCAL,0,CHARANUM
						SIF CFLAG:LOCAL:現在位置 == 場所_屋外トイレ
							LOCAL:1++
						SIF CFLAG:LOCAL:現在位置 == 場所_1Fトイレ
							LOCAL:2 ++
					NEXT
					IF LOCAL:1 != 0 && LOCAL:2 > 1
						RESULT:(LOCAL:3) = 場所_2Fトイレ * 倍_万 + 10
						LOCAL:3 ++
					ENDIF
				ENDIF
			CASE 場所_大浴場
				IF CFLAG:(ARG:1):風呂 >= 1000
					RESULT:(LOCAL:3) = 場所_大浴場 * 倍_万 + 8000
					LOCAL:3 ++
				ENDIF
			CASEELSE
				RESULT:(LOCAL:3) = LOCAL:4 * 倍_万 + (FLAG:(100 + LOCAL:4) + 100)
				LOCAL:3 ++
		ENDSELECT
		
	NEXT
	
	
;-------------------------------------------------------------------------------
;FIXME:関数の説明を書いてください
;@return 2:移動可＋目視可, 1:移動可, 0:移動不可
@CAN_MOVE(場所0, 場所1)
	#FUNCTION
	#DIM 場所0
	#DIM 場所1
	;RETURNF 2は間に扉がなく見透かせる。庭から二階は見えないが逆は見える
	SELECTCASE 場所0
			;正門から
		CASE 場所_正門
			;広間（階段）
			SIF 場所1 == 場所_広間
				RETURNF 1
			;守衛小屋
			SIF 場所1 == 場所_守衛小屋
				RETURNF 1
			;納屋
			SIF 場所1 == 場所_納屋
				RETURNF 1
			;庭 + 見える
			SIF 場所1 == 場所_庭
				RETURNF 2
			;湖北部
			SIF 場所1 == 場所_湖
				RETURNF 1
			;広間（階段）から
		CASE 場所_広間
			;正門
			SIF 場所1 == 場所_正門
				RETURNF 1
			;食堂
			SIF 場所1 == 場所_食堂
				RETURNF 1
			;図書室
			SIF 場所1 == 場所_図書室
				RETURNF 1
			;踊り場 + 見える
			SIF 場所1 == 場所_二階踊り場
				RETURNF 2
			;地下室
			SIF 場所1 == 場所_地下室
				RETURNF 1
			;大浴場
			SIF 場所1 == 場所_大浴場
				RETURNF 1
			;1Fトイレ
			SIF 場所1 == 場所_1Fトイレ
				RETURNF 1
			;食堂から
		CASE 場所_食堂
			;広間（階段）
			SIF 場所1 == 場所_広間
				RETURNF 1
			;厨房
			SIF 場所1 == 場所_厨房
				RETURNF 1
			;守衛小屋
			SIF 場所1 == 場所_守衛小屋
				RETURNF 1
			;庭 + 見える
			SIF 場所1 == 場所_庭
				RETURNF 2
			;屋外トイレ
			SIF 場所1 == 場所_屋外トイレ
				RETURNF 1
			;図書室から
		CASE 場所_図書室
			;広間（階段）
			SIF 場所1 == 場所_広間
				RETURNF 1
			;パチュリー私室
			SIF 場所1 == 場所_パチュリー私室
				RETURNF 1
			;小悪魔私室
			SIF 場所1 == 場所_小悪魔私室
				RETURNF 1
			;厨房から
		CASE 場所_厨房
			;食堂
			SIF 場所1 == 場所_食堂
				RETURNF 1
			;納屋から
		CASE 場所_納屋
			;庭
			SIF 場所1 == 場所_庭
				RETURNF 1
			;パチュリー私室から
		CASE 場所_パチュリー私室
			;図書室
			SIF 場所1 == 場所_図書室
				RETURNF 1
			;小悪魔私室から
		CASE 場所_小悪魔私室
			;図書室
			SIF 場所1 == 場所_図書室
				RETURNF 1
			;守衛小屋から
		CASE 場所_守衛小屋
			;正門
			SIF 場所1 == 場所_正門
				RETURNF 1
			;食堂
			SIF 場所1 == 場所_食堂
				RETURNF 1
			;庭
			SIF 場所1 == 場所_庭
				RETURNF 1
			;屋外トイレ
			SIF 場所1 == 場所_屋外トイレ
				RETURNF 1
			;庭から
		CASE 場所_庭
			;正門 + 見える
			SIF 場所1 == 場所_正門
				RETURNF 2
			;食堂 + 見える
			SIF 場所1 == 場所_食堂
				RETURNF 2
			;納屋
			SIF 場所1 == 場所_納屋
				RETURNF 1
			;守衛小屋
			SIF 場所1 == 場所_守衛小屋
				RETURNF 1
			;屋外トイレ
			SIF 場所1 == 場所_屋外トイレ
				RETURNF 1
			;踊り場から
		CASE 場所_二階踊り場
			;広間（階段） + 見える
			SIF 場所1 == 場所_広間
				RETURNF 2
			;二階廊下 + 見える
			SIF 場所1 == 場所_二階廊下
				RETURNF 2
			;レミリア私室
			SIF 場所1 == 場所_レミリア私室
				RETURNF 1
			;二階廊下から
		CASE 場所_二階廊下
			;踊り場 + 見える
			SIF 場所1 == 場所_二階踊り場
				RETURNF 2
			;咲夜私室
			SIF 場所1 == 場所_咲夜私室
				RETURNF 1
			;妖精メイド詰所
			SIF 場所1 == 場所_妖精メイド詰め所
				RETURNF 1
			;あなた私室
			SIF 場所1 == 場所_あなた私室
				RETURNF 1
			;2Fトイレ
			SIF 場所1 == 場所_2Fトイレ
				RETURNF 1
			;咲夜私室から
		CASE 場所_咲夜私室
			;庭 + 見える
			SIF 場所1 == 場所_庭
				RETURNF 2
			;二階廊下
			SIF 場所1 == 場所_二階廊下
				RETURNF 1
			;妖精メイド詰所から
		CASE 場所_妖精メイド詰め所
			;庭 + 見える
			SIF 場所1 == 場所_庭
				RETURNF 2
			;二階廊下
			SIF 場所1 == 場所_二階廊下
				RETURNF 1
			;あなた私室から
		CASE 場所_あなた私室
			;庭 + 見える
			SIF 場所1 == 場所_庭
				RETURNF 2
			;二階廊下
			SIF 場所1 == 場所_二階廊下
				RETURNF 1
			;レミリア私室から
		CASE 場所_レミリア私室
			;庭 + 見える
			SIF 場所1 == 場所_庭
				RETURNF 2
			;踊り場
			SIF 場所1 == 場所_二階踊り場
				RETURNF 1
			;3Fテラス
			SIF 場所1 == 場所_3Fテラス
				RETURNF 1
			;地下室から
		CASE 場所_地下室
			;広間（階段）
			SIF 場所1 == 場所_広間
				RETURNF 1
			;大浴場から
		CASE 場所_大浴場
			;広間（階段）
			SIF 場所1 == 場所_広間
				RETURNF 1
			;湖北部から
		CASE 場所_湖
			;正門
			SIF 場所1 == 場所_正門
				RETURNF 1
			;湖南部
			SIF 場所1 == 場所_湖南部
				RETURNF 1
			;森内部
			SIF 場所1 == 場所_魔法の森内部
				RETURNF 1
			;チルノの家から
		CASE 場所_チルノの家
			;湖南部
			SIF 場所1 == 場所_湖南部
				RETURNF 1
			;大妖精の家から
		CASE 場所_大妖精の家
			;湖南部
			SIF 場所1 == 場所_湖南部
				RETURNF 1
		CASE 場所_魔理沙の家
			;森内部
			SIF 場所1 == 場所_魔法の森内部
				RETURNF 1
			;お手洗いパッチ拡張
			;トイレはどこからも覗けない
			;屋外トイレから

		CASE 場所_屋外トイレ
			;庭
			SIF 場所1 == 場所_庭
				RETURNF 1
			;守衛小屋
			SIF 場所1 == 場所_守衛小屋
				RETURNF 1
			;食堂
			SIF 場所1 == 場所_食堂
				RETURNF 1
			;1Fトイレから
		CASE 場所_1Fトイレ
			;広間（階段）
			SIF 場所1 == 場所_広間
				RETURNF 1
			;2Fトイレから
		CASE 場所_2Fトイレ
			;二階廊下
			SIF 場所1 == 場所_二階廊下
				RETURNF 1
			;3Fテラスから
		CASE 場所_3Fテラス
			;庭 + 見える
			SIF 場所1 == 場所_庭
				RETURNF 2
			;正門 + 見える
			SIF 場所1 == 場所_正門
				RETURNF 2
			;レミリア私室
			SIF 場所1 == 場所_レミリア私室
				RETURNF 1
				
			;湖南部から
		CASE 場所_湖南部
			;湖北部
			SIF 場所1 == 場所_湖
				RETURNF 1
			;チルノの家
			SIF 場所1 == 場所_チルノの家
				RETURNF 1
			;大妖精の家
			SIF 場所1 == 場所_大妖精の家
				RETURNF 1
			;魔法の森内部から
		CASE 場所_魔法の森内部
			;湖北部
			SIF 場所1 == 場所_湖
				RETURNF 1
			;魔理沙の家
			SIF 場所1 == 場所_魔理沙の家
				RETURNF 1
			;ルーミアの住処
			SIF 場所1 == 場所_ルーミアの住処
				RETURNF 1
			;アリスの家
			SIF 場所1 == 場所_アリスの家
				RETURNF 1
			;ルーミアの住処から
		CASE 場所_ルーミアの住処
			;森内部
			SIF 場所1 == 場所_魔法の森内部
				RETURNF 1
			;博麗神社から
		CASE 場所_博麗神社
			;湖北部
			SIF 場所1 == 場所_湖
				RETURNF 1
			;アリスの家から
		CASE 場所_アリスの家
			;森内部
			SIF 場所1 == 場所_魔法の森内部
				RETURNF 1
	ENDSELECT

;-------------------------------------------------------------------------------
;指定した時間から現在までの経過時間を返す
;@param 基準時刻  基準とする時間
;@return 現在の時間との差分（分）
@TIME_PROGRESS(基準時刻)
	#FUNCTION
	#DIM 基準時刻
RETURNF DATETIME() - 基準時刻

;-------------------------------------------------------------------------------
;キャラクターを眠らせる処理
;@param 住人 対象となるキャラクター
@CHARA_SLEEP(住人)
	#DIM 住人
	VARSET LOCAL
	IF (CAN_MOVE(CFLAG:MASTER:現在位置, CFLAG:住人:現在位置) == 2 || CFLAG:MASTER:現在位置 == CFLAG:住人:現在位置) && !CFLAG:MASTER:睡眠
		IF CFLAG:住人:現在位置 == CFLAG:住人:開始位置
			IF TALENT:住人:恋慕 == 1
				IF CFLAG:住人:睡眠
					PRINTFORM %CALLNAME:住人% is 
					IF CFLAG:住人:睡眠深度 > 2500
						PRINTW sleeping like a baby.
					ELSEIF CFLAG:住人:睡眠深度 > 800
						PRINTW sleeping deeply.
					ELSEIF CFLAG:住人:睡眠深度 > 500
						PRINTW sleeping soundly.
					ELSEIF CFLAG:住人:睡眠深度 > 200
						PRINTW turning over while sleeping.
					ELSE
						PRINTL starting to sleep-talking a little.
						PRINTW %HE_SHE(住人, 1)% might wake up if you keep being noisy.
					ENDIF
				ELSE
					PRINTFORMW %CALLNAME:住人% fell asleep.
				ENDIF
				LOCAL = 2
			ELSE
				PRINTFORMW %CALLNAME:住人% is sleeping.
				LOCAL = 1
			ENDIF
		ELSE
			IF CFLAG:住人:衰弱 && TALENT:住人:恋慕 && CFLAG:MASTER:現在位置 == CFLAG:住人:現在位置
				PRINTFORMW You carried %CALLNAME:住人% from %GETPLACENAME(CFLAG:住人:現在位置)% to %GETPLACENAME(CFLAG:住人:311)%.
				LOCAL = 3
			ELSE
				PRINTFORMW %CALLNAME:住人% has returned from %GETPLACENAME(CFLAG:住人:現在位置)% to %GETPLACENAME(CFLAG:住人:311)%.
				LOCAL = 0
			ENDIF
		ENDIF
		;おやすみ口上
		SIF CFLAG:MASTER:現在位置 == CFLAG:住人:現在位置
			CALL KOJO_EVENT(7, 住人, LOCAL)
	ENDIF
	;自室でねる
	CFLAG:住人:現在位置 = CFLAG:住人:開始位置
	SIF LOCAL == 3
		CFLAG:MASTER:現在位置 = CFLAG:住人:開始位置
	;子悪魔以外は施錠する
	IF NO:住人 != 7
		FLAG:(300 + CFLAG:住人:現在位置) = 1
	ENDIF
	CFLAG:住人:同行 = 0
	CFLAG:住人:睡眠 = 1
	CFLAG:(住人:0):就寝時間 = TIME_PROGRESS(0)
	CFLAG:住人:うふふ = 0
	CFLAG:住人:自慰中 = 0
	;衰弱してなくて、着替えてなければ寝間着に着替える
	IF !CFLAG:住人:衰弱 && !CFLAG:住人:寝間着着用
		CALL CLOTHES_SETTING(住人,0)
		CFLAG:住人:起床時間外 = 1
	ENDIF
	SIF !CFLAG:住人:睡眠深度
		CFLAG:住人:睡眠深度 = 1000
RETURN 0

;-------------------------------------------------------------------------------
;キャラクターを起こす処理
;@param 住人 対象となるキャラクター
@CHARA_AWAKE(住人)
	#DIM 住人

	IF CFLAG:住人:睡眠 && CFLAG:住人:現在位置 == CFLAG:MASTER:現在位置
		SIF 住人 > 0
			PRINTFORMW %CALLNAME:住人% has awoken.
		;おはよう口上
		CALL KOJO_EVENT(6, 住人)
	ENDIF
	SIF CFLAG:住人:睡眠
		CFLAG:住人:起床後寝間着時間 = 60
	SIF CFLAG:住人:睡眠深度
		CFLAG:住人:睡眠深度 = 0
	CFLAG:住人:睡眠 = 0
	CFLAG:住人:起床時間 = TIME_PROGRESS(0)
	;施錠
	FLAG:(300 + CFLAG:住人:現在位置) = 0
RETURN 0

;-------------------------------------------------------------------------------
;キャラクターの移動条件(一部強制的な移動も含む)
;@return 1:行動可、0:行動不可
@CHARA_MOVEMENT_T(住人)
	#DIM 住人
	
	;うふふ中は不可
	SIF CFLAG:住人:うふふ
		RETURN 0
	;汚れ発覚による逃走処理
	IF CFLAG:住人:汚れ発覚 == 汚れ発覚_逃走 && BATHROOM(CFLAG:住人:現在位置) 
		;お風呂に入ったら汚れ発覚による逃走終了
		CFLAG:住人:汚れ発覚 = 汚れ発覚_なし
	ENDIF
	IF CFLAG:住人:汚れ発覚 == 汚れ発覚_逃走 && !CFLAG:住人:睡眠
		LOCAL = 場所_大浴場
		PRINTFORMW %CALLNAME:住人% has moved from【%GETPLACENAME(CFLAG:住人:現在位置)%】towards【%GETPLACENAME(LOCAL)%】.
		CFLAG:住人:汚れ発覚 = 汚れ発覚_なし
		CFLAG:住人:同行 = 0
		CFLAG:住人:現在位置 = LOCAL
		CALL NTR_CHK_CHAR_MOVE(住人)
		RETURN 0
	ENDIF
	;MASTERに同行しているなら不可
	SIF CFLAG:住人:同行
		RETURN 0
	;部屋で自慰中なら不可
	SIF CFLAG:住人:自慰中 > 0 && IS_PRIVATE_ROOM(住人, 0)
		RETURN 0
	;訪問者に何かされている間は不可
	SIF CFLAG:住人:現在位置 == FLAG:訪問者の現在位置 && (FLAG:訪問者との行為の終了時刻 > DATETIME() || FLAG:訪問者との行為の終了時刻 != 0)
		RETURN 0
	;住人同士で何かしている間は不可
	SIF CFLAG:住人:住人同士イベント相手 != 0 || CFLAG:住人:住人同士イベント内容 != 0
		RETURN 0
	;訪問者宅にいる間は不可
	SIF CFLAG:住人:現在位置 == 場所_訪問者宅
		RETURN 0
	;野外調教を受けている間は不可
	SIF CFLAG:住人:NTR野外調教 != 0
		RETURN 0
	
	IF !CFLAG:住人:幽閉 && !CFLAG:住人:衰弱 && REST_NeedRestroom(住人) > 1
		;幽閉、衰弱以外で「漏らしそう」であれば活動時間帯に関係なく覚醒し、行動できる。
		CALL CHARA_AWAKE, 住人
		RETURN 1
	ELSEIF !CFLAG:住人:幽閉 && !CFLAG:住人:衰弱 && AFTER_REST_ROOM(住人)
		;幽閉、衰弱以外でトイレから帰る時は常に行動可能（そうしないとトイレで寝てしまう）
		RETURN 1
	ENDIF
	
	;活動時間帯のチェック
	TRYCCALLFORM CHARA_MOVEMENT_ACTIVETIME_{CFLAG:住人:298}(住人)
	CATCH
		;個別指定が無ければ標準的な移動判定
		IF CFLAG:住人:298 == 148 || CFLAG:住人:298 == 149
			TRYCALL CHARA_MOVEMENT_ACTIVETIME_CHILD(住人)
		ELSE
			;基本的には2時寝10時起き(いいのか？)
			RESULT = (TIME > 120 && TIME < 600) || CFLAG:住人:衰弱
		ENDIF
	ENDCATCH
	IF RESULT
		;活動時間帯判定の結果、寝ている時は行動不可
		CALL CHARA_SLEEP, 住人
		RETURN 0
	ELSE
		;目を覚ます
		CALL CHARA_AWAKE, 住人
		CFLAG:住人:起床時間外 = 0
	ENDIF
	
	;起きていても動けない判定-----
	IF CFLAG:住人:幽閉
		;幽閉時は行動不可
		RETURN 0
	ENDIF
	IF CFLAG:住人:衰弱
		;衰弱時は行動不可
		RETURN 0
	ENDIF
	;霊夢の場合、霊夢移動フラグが立ってる且つ寝室だと動かない
	IF NO:住人 == 人物_霊夢 && 霊夢移動フラグ && CFLAG:住人:現在位置 == CFLAG:住人:開始位置
		RETURN 0
	ENDIF
	
	RETURN 1
	
;-------------------------------------------------------------------------------
;キャラクターの移動
;@param 住人 キャラクター番号
;@return 1以上:移動箇所、0:行動不可
@CHARA_MOVEMENT_T2(住人)
	#DIM 住人
	#DIM LOOT_POS
	#DIM LOOT_NUM
	#DIM LOOT_PROB
	
	;なんらかの理由による目的地設定及び移動−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
	
	;移動不可による無限ループを防ぐ為その場で足踏み処理
	SIF CFLAG:住人:現在位置 == 場所_人間の里
		RETURN 場所_人間の里
	SIF CFLAG:住人:現在位置 == 場所_民家
		RETURN 場所_民家
	
	IF CFLAG:住人:移動目的 == 0
		;尿意を感じた時、トイレに向ける
		IF (REST_NeedRestroom(住人)>0) && !REST_IsRestRoom(CFLAG:住人:現在位置)
			CALLF FARMOVE(住人, CFLAG:住人:現在位置, GO_TO_RESTROOM(住人))
			CFLAG:住人:離席前の位置 = CFLAG:住人:現在位置
			CFLAG:住人:移動目的 = 移動目的_WC移動
		;トイレからの帰り道
		ELSEIF AFTER_REST_ROOM(住人)
			CALLF FARMOVE(住人, CFLAG:住人:現在位置, CFLAG:住人:離席前の位置)
			CFLAG:住人:離席前の位置 = 0
			CFLAG:住人:移動目的 = 移動目的_WC帰路
		;妊娠していて自室に居ない場合は自室へ戻る
		ELSEIF CFLAG:住人:にんっしんっ > 0 && !IS_PRIVATE_ROOM(住人, 0)
			;目標地点までのルート設定
			CALLF FARMOVE(住人, CFLAG:住人:現在位置, GET_PRIVATE_ROOM(住人, 0))
			CFLAG:住人:移動目的 = 移動目的_妊娠自室
		;訪問者のお仕置きによるあなたの前からの逃避行動
		ELSEIF CHK_NTR_ESCAPE(住人)
			;自室以外なら自室へ逃避、自室にいたら正門に逃避
			IF !IS_PRIVATE_ROOM(住人, 0)
				CALLF FARMOVE(住人, CFLAG:住人:現在位置, GET_PRIVATE_ROOM(住人, 0))
			ELSE
				CALLF FARMOVE(住人, CFLAG:住人:現在位置, 場所_正門)
			ENDIF
			CFLAG:住人:移動目的 = 移動目的_NTR逃避
		ENDIF
	ELSEIF CFLAG:住人:移動目的 == 移動目的_訪問者 && 移動ルート:住人:0 == 0
		;訪問者の元への移動かつ初期状態であれば移動ルート設定
		IF FLAG:訪問者の現在位置 == 場所_訪問者宅
			; 訪問者が自宅にいたらおでかけ可能かチェック、おでかけできるなら行く
			; 行けない場合は仕方ないので正門に行ってフラグ解除して終了
			CALL GoOut_Able_Check(住人)
			IF RESULT:0
				CALL GoOut_SeeYou(住人, 1)
			ELSE
				CALLF FARMOVE(住人, CFLAG:住人:現在位置, 場所_正門)
			ENDIF
			CFLAG:住人:移動目的 = 0
		ELSE
			CALLF FARMOVE(住人, CFLAG:住人:現在位置, FLAG:訪問者の現在位置)
		ENDIF
	ENDIF
	;自慰判定
	IF CFLAG:住人:移動目的 == 0
		CALL キャラ自慰判定, 住人
		IF RESULT
			IF CFLAG:住人:現在位置 != GET_PRIVATE_ROOM(住人, 0)
				CALLF FARMOVE(住人, CFLAG:住人:現在位置, GET_PRIVATE_ROOM(住人, 0))
				CFLAG:住人:移動目的 = 移動目的_自慰自室
			ELSE
				;既に自室にいるなら移動せず行為開始
				RETURN 0
			ENDIF
		ENDIF
	ENDIF
	
	;目的地が設定されているならそこへ移動
	IF 移動ルート:住人:0
		LOCAL = 移動ルート:住人:0
		CALL SORT_ROUTE(住人)
		RETURN LOCAL
	ENDIF
	;妊娠していて自室に居る場合は現状維持
	IF CFLAG:住人:にんっしんっ > 0 && IS_PRIVATE_ROOM(住人, 0)
		RETURN 0
	ENDIF
	
	;その他目的のない短距離移動−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
	;移動確率の決定
	TRYCCALLFORM CHARA_MOVEMENT_MOVERATE_{CFLAG:住人:298}
	CATCH
		IF CFLAG:住人:298 == 148 || CFLAG:住人:298 == 149
			TRYCALL CHARA_MOVEMENT_MOVERATE_CHILD(住人)
		ELSE
			RESULT = 90
		ENDIF
	ENDCATCH
	IF RAND:(TIME_PROGRESS(TFLAG:300) + 1) <= RAND:RESULT
		RETURN 0
	ENDIF
	IF FLAG:訪問者の現在位置 == CFLAG:住人:現在位置 && FLAG:訪問者との行為の終了時刻 != 0
		;訪問者に捕まっている場合(非監禁的な意味で)は移動不可
		RETURN 0
	ENDIF
	;ここから移動場所の決定
	VARSET RESULT
	
	;キャラ別移動可能箇所とその確率を取得
	TRYCCALLFORM CHARA_MOVEMENT_{CFLAG:住人:298}(LOCAL,住人)
	CATCH
		;子供の場合
		IF CFLAG:住人:298 == 148 || CFLAG:住人:298 == 149
			TRYCALL CHARA_MOVEMENT_CHILD(LOCAL,住人)
		;それ以外のキャラの場合は納屋を除いた全てを範囲に
		ELSE
			SIF LOCAL != 6
				RESULT = 100
		ENDIF
	ENDCATCH
	
	
	;LOOT_POS 向かう場所
	;RESULT:1~ 向かう場所の番号(*10000)と向かう確率
	LOOT_POS = 0
	LOCAL = 1
	DO
		LOOT_NUM = RESULT:LOCAL / 倍_万
		LOOT_PROB = RESULT:LOCAL % 倍_万
		
		;現在地と隣接した場所のみ移動可能
		LOOT_PROB = LOOT_PROB * (CAN_MOVE(CFLAG:住人:現在位置, LOOT_NUM) > 0 && CAN_MOVE(CFLAG:住人:現在位置, LOOT_NUM) < 3)
		;同じ場所は０にする
		SIF LOOT_NUM == CFLAG:住人:現在位置
			LOOT_PROB = 0
		SIF LOOT_PROB
			LOOT_PROB = RAND:(LOOT_PROB) + 1
		
		;%CALLNAME:MASTER%が見えたら態度に応じて接近しやすく
		SIF LOOT_NUM == CFLAG:MASTER:現在位置 && CAN_MOVE(CFLAG:住人:現在位置, CFLAG:MASTER:現在位置) == 2 
			LOOT_PROB += LOOT_PROB / 10 * CFLAG:住人:馴れ合い強度度
		;訪問者が紅魔館のアイドルならば、接近します。
		SIF LOOT_NUM == FLAG:訪問者の現在位置 && CAN_MOVE(CFLAG:住人:現在位置, FLAG:訪問者の現在位置) == 2
			LOOT_PROB += MAX(0, (CFLAG:住人:屈服度 - CFLAG:住人:好感度) / 3)
			
		;PRINTFORM {RESULT:LOCAL} {LOOT_PROB}｜
		;場所判定
		SIF LOOT_POS % 倍_万 < LOOT_PROB
			LOOT_POS = LOOT_NUM * 倍_万 + LOOT_PROB
		LOCAL ++
	LOOP RESULT:LOCAL != 0
	;PRINTW
	;PRINTFORMW CHARA %CALLNAME:住人% MOVEMENT {CFLAG:住人:現在位置} → {LOOT_POS / 倍_万} {LOOT_POS}
	;PRINTL
;目標地点を返す
RETURN (LOOT_POS / 倍_万)

;-------------------------------------------------------------------------------
;訪問者のお仕置きによるあなたの前からの逃避行動の判定
;@return 1:逃避行動発生,0:逃避行動発生しない
@CHK_NTR_ESCAPE(住人)
	#FUNCTION
	#DIM 住人
	#DIM 発生閾値

	;あなたは例外
	SIF 住人 == MASTER
		RETURNF 0
	;コンフィグでOFFなら発生しない
	SIF !IS_NTR_ESCAPE()
		RETURNF 0
	;睡眠中は発生しない
	SIF CFLAG:住人:睡眠
		RETURNF 0
	;あなたと同じ場所にいないと発生しない
	SIF CFLAG:MASTER:現在位置 != CFLAG:住人:現在位置
		RETURNF 0
	;同行中は発生しない
	SIF CFLAG:住人:同行
		RETURNF 0
	;訪問者に挿入されたローター作動中でないと発生しない
	IF (CFLAG:住人:ローター挿入 == 0 && CFLAG:住人:ローターA挿入 == 0) || CFLAG:住人:ローター挿入者 != 人物_訪問者
		RETURNF 0
	ENDIF
	;浮気公認だと発生しない
	;SIF TALENT:住人:浮気公認
	;	RETURNF 0
	;恋慕か非恋慕かで確率変化
	IF TALENT:住人:恋慕
		発生閾値 = 10
		;親愛、人妻だと確率増加
		SIF TALENT:住人:親愛
			発生閾値 += 5
		SIF TALENT:住人:人妻
			発生閾値 += 5
	ELSE
		発生閾値 = 5
	ENDIF
	;閾値より大きいと逃避行動発生しない
	SIF RAND:100 > 発生閾値
		RETURNF 0
RETURNF 1

;-------------------------------------------------------------------------------
;指定した場所にいる住人の人数を返す
;場所…場所の指定
;戻り値…指定した場所にいる住人の人数
@COUNT_MEM_IN_POS(場所)
	#FUNCTION
	#DIM 場所
	#DIM 人数
	#DIM LOOP_CHR

	人数 = 0
	FOR LOOP_CHR,1,CHARANUM
		SIF CFLAG:LOOP_CHR:現在位置 == 場所
			人数 ++
	NEXT
RETURNF 人数

;-------------------------------------------------------------------------------
;現在位置が個人の私室か判定
;住人…キャラ番号
;子悪魔FLG…子悪魔例外処理フラグ 0:寝る部屋 1:うふふ時誘う場所
@IS_PRIVATE_ROOM(住人, 子悪魔FLG)
	#FUNCTION
	#DIM 住人
	#DIM 子悪魔FLG
RETURNF (CFLAG:住人:現在位置 == GET_PRIVATE_ROOM(住人, 子悪魔FLG) ? 1 # 0)

;-------------------------------------------------------------------------------
;個人の私室を返す
;住人…キャラ番号
;子悪魔FLG…子悪魔例外処理フラグ 0:寝る部屋 1:うふふ時誘う場所
@GET_PRIVATE_ROOM(住人, 子悪魔FLG)
	#FUNCTION
	#DIM 住人
	#DIM 子悪魔FLG
	LOCAL = 0
	SELECTCASE 住人
			; 美鈴
		CASE 1
			LOCAL =	場所_守衛小屋
			; 小悪魔
		CASE 2
			LOCAL =	場所_小悪魔私室
			; パチュリー
		CASE 3
			LOCAL =	場所_パチュリー私室
			; 咲夜
		CASE 4
			LOCAL =	場所_咲夜私室	
			; レミリア
		CASE 5 
			LOCAL =	場所_レミリア私室
			; フランドール
		CASE 6
			LOCAL =	場所_地下室
			; 子悪魔
		CASE 7
			IF 子悪魔FLG == 0
				IF TALENT:住人:恋慕
					LOCAL =	場所_あなた私室
				ELSE
					LOCAL =	場所_小悪魔私室
				ENDIF
			ELSE
				LOCAL =	場所_納屋
			ENDIF
			; チルノ
		CASE 8 
			LOCAL =	場所_チルノの家
			; 大妖精
		CASE 9
			LOCAL =	場所_大妖精の家
			; 魔理沙
		CASE 10
			LOCAL =	場所_魔理沙の家
			; 霊夢
		CASE 11
			LOCAL =	場所_博麗神社
			; ルーミア
		CASE 12
			LOCAL =	場所_ルーミアの住処
			; アリス
		CASE 13
			LOCAL =	場所_アリスの家
			;その他
		CASEELSE
			LOCAL =	CFLAG:住人:311
	ENDSELECT
RETURNF LOCAL

;----------------------
@キャラ自慰判定(奴隷)
	#DIM 奴隷
	#DIM LOOP_CHR
	#DIM 好屈度		; 好感度 or 屈服度の高い方

	;自慰発生条件
	;・性欲が90以上
	SIF CFLAG:奴隷:性欲 < 90
		RETURN 0
	;・眠っていない
	SIF CFLAG:奴隷:睡眠 == 1
		RETURN 0
		;PRINTFORM {奴隷}P0 
	;・トイレに行く気がない
	SIF REST_NeedRestroom(奴隷)
		RETURN 0
		;PRINTFORM {奴隷}P1 
	;・体力気力が半分以上
	SIF (BASE:奴隷:体力 <= (MAXBASE:奴隷:体力/2) || BASE:奴隷:気力 <= (MAXBASE:奴隷:気力/2))
		RETURN 0
	;PRINTFORM {奴隷}P2 
	;・訪問者と同じ場所にいない
	SIF CFLAG:奴隷:現在位置 == FLAG:訪問者の現在位置
		RETURN 0
	;PRINTFORM {奴隷}P3 
	;・お持ち帰りされていない
	SIF CFLAG:奴隷:現在位置 == 場所_訪問者宅
		RETURN 0
	;PRINTFORM {奴隷}P4 
	;誰かが見えていない
	FOR LOOP_CHR, 0, CHARANUM
		IF 奴隷 != LOOP_CHR
			IF CAN_MOVE(CFLAG:LOOP_CHR:現在位置,CFLAG:奴隷:現在位置) == 2
				RETURN 0
			ENDIF
		ENDIF
	NEXT
	;・発生確率を満たしている
	SIF RAND:(MAX(70-(CFLAG:奴隷:性欲-90), 2))
		RETURN 0
	;PRINTFORM {奴隷}P5 
	;満足にいたる絶頂回数設定
	;自慰を中断しているなら残り回数を取得
	IF CFLAG:奴隷:自慰中 < 0
		CFLAG:奴隷:自慰中 = ABS(CFLAG:奴隷:自慰中)
	;欲望＋自慰中毒＋好感度OR屈服度
	ELSEIF CFLAG:奴隷:自慰中 == 0
		CFLAG:奴隷:自慰中 = MAX((ABL:奴隷:欲望 + ABL:奴隷:自慰中毒) / 2, 1)

		好屈度 = MAX(CFLAG:奴隷:好感度, CFLAG:奴隷:屈服度)
		IF 好屈度 >= 5000
			CFLAG:奴隷:自慰中 = MIN(CFLAG:奴隷:自慰中+10 , 10)
		ELSEIF 好屈度 >= 2500
			CFLAG:奴隷:自慰中 = MIN(CFLAG:奴隷:自慰中+7 , 10)
		ELSEIF 好屈度 >= 1000
			CFLAG:奴隷:自慰中 += 4
		ELSEIF 好屈度 >= 300
			CFLAG:奴隷:自慰中 += 2
		ENDIF
	ENDIF

	;PRINTFORML %CALLNAME:奴隷%は部屋に戻り自慰を始めた（{CFLAG:奴隷:自慰中}）

RETURN 1

